---
title: "Análisis de los factores que influyen en la decisión de compra de vivienda a nivel internacional"
author: "Ander Castro & Lucas Martinez"
date: "2025-11-06"
output:
  cleanrmd::html_document_clean:
    theme: kacit
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
      smooth_scroll: true
link-citations: true
---

```{r, echo=FALSE, out.width="100%", fig.align="center"}
knitr::include_graphics("./portada.png")
```

# 1. Introducción

La compra de vivienda es uno de los procesos financieros más importantes para los individuos y familias en todo el mundo. Para la mayoría de compradores, esta adquisición se realiza a través de un préstamo hipotecario, por lo que las instituciones financieras evalúan múltiples factores para determinar si un solicitante es elegible para un crédito y bajo qué condiciones.

El mercado inmobiliario global es un sector clave en la economía, moviendo miles de millones de dólares anualmente. La correcta evaluación del perfil financiero del comprador, junto con las características del inmueble, es fundamental tanto para garantizar el acceso a la vivienda como para reducir el riesgo económico de las entidades financieras.

## 1.1 Obtención de los datos

El set de datos fue obtenido de la plataforma Kaggle y contiene información global sobre compras de vivienda y decisiones de aprobación hipotecaria. Incluye 200,000 registros (muestras) con 25 variables relacionadas tanto con la propiedad como con el comprador y su historial financiero.

El objetivo principal de este estudio es realizar un análisis estadístico para comprender qué factores influyen en la aprobación o rechazo de un préstamo hipotecario. Asimismo, se buscará identificar qué características del comprador y de la propiedad tienen mayor peso en la decisión final y desarrollar modelos predictivos que permitan anticipar el resultado de aprobación crediticia.

## 1.2 Metodología

A lo largo de este trabajo, se pretenden analizar las siguientes preguntas:

- *¿Qué variables explican mejor el precio de una vivienda?*
  - ¿Influyen el país, tipo de propiedad, tamaño, número de habitaciones o el estado de
  mobiliario?
  - ¿Qué relación existe entre el precio y variables como el salario del comprador, el
  número de propietarios anteriores o el año de construcción?
  
- *¿Qué factores determinan la decisión de compra (variable decision)?*
  - ¿Qué peso tienen variables como el ratio EMI/income, el nivel de satisfacción
  (satisfaction_score), el rating del vecindario (neighbourhood_rating) o la conectividad
  (connectivity_score)?
  - ¿Se puede predecir la decisión de compra con un modelo de clasificación?
  
- *¿Existen diferencias significativas entre países o ciudades en cuanto a precios y decisiones de compra?*
  - ¿Qué países tienen precios más altos en promedio?
  - ¿Hay diferencias en la tasa de compra (decision = 1) entre regiones?

- *¿Cómo se distribuye el precio de las viviendas y hasta qué punto es posible predecirlo con modelos estadísticos y de machine learning?*
  - ¿Se ajusta a una distribución teórica conocida (gamma, log-normal, normal)?
  - ¿Qué modelo de regresión (lineal, regularizado o de machine learning) ofrece mejor
  rendimiento en la predicción del precio?
  - ¿Qué variables son más relevantes en la estimación?
  
- *¿Qué insights se pueden extraer sobre el perfil del comprador?*
  - ¿Qué relación hay entre salario, gastos mensuales, préstamo y decisión de compra?
  - ¿Influyen los aspectos legales (legal_cases_on_property) o de seguridad
  (crime_cases_reported)?

El análisis se llevará a cabo en dos fases principales:

### **Volumen 1: Análisis Exploratorio y Estadístico**
1. Importación de librerías y datos  
2. Resumen estadístico general 
3. Visualización de datos
4. Contraste de hipótesis y estadística inferencial
5. PCA: Análisis de Componentes Principales  
    - Varianza explicada  
    - Componentes principales

### **Volumen 2: Machine Learning**
6. Modelo para la decisión de compra (clasificación)  
7. Modelo para el precio de la vivienda  
8. Interpretación de resultados
9. Conclusiones y limitaciones
10. Referencias

## 1.3 Variables del dataset

El conjunto de datos **Global House Purchase Decision Dataset** contiene información detallada sobre propiedades residenciales, características del entorno y perfil financiero de los compradores. En total, incluye **200.000 observaciones** y **25 variables**, que permiten analizar los factores que influyen en la decisión de compra.

A continuación, se describen las variables incluidas en el dataset:

- `property_id`: Identificador único de cada propiedad.
- `country`: País donde se encuentra la propiedad.  
- `city`: Ciudad en la que está ubicada la vivienda.  
- `property_type`: Tipo de propiedad.
- `furnishing_status`: Nivel de amueblado del inmueble.  
- `property_size_sqft`: Tamaño total de la propiedad en pies cuadrados.
- `price`: Precio de la vivienda en dólares estadounidenses (USD).  
- `constructed_year`: Año en el que se construyó la propiedad.
- `previous_owners`: Número de propietarios previos.
- `rooms`: Número de dormitorios de la vivienda.  
- `bathrooms`: Número de baños de la vivienda.
- `garage`: Indica si la propiedad dispone de garaje propio (variable binaria: 1 = sí, 0 = no).
- `garden`: Indica si la propiedad cuenta con jardín o espacio exterior privado (variable binaria: 1 = sí, 0 = no).
- `crime_cases_reported`: Número de crímenes reportados en la zona (indicador de seguridad).
- `legal_cases_on_property`: Número de casos legales asociados a la propiedad.
- `customer_salary`: Salario del comprador (en USD).  
- `loan_amount`: Monto solicitado del préstamo hipotecario.  
- `loan_tenure_years`: Duración del préstamo en años.  
- `monthly_expenses`: Gastos mensuales promedio del comprador.
- `down_payment`: Cantidad inicial que el comprador aporta en efectivo para la compra, antes del préstamo hipotecario.
- `emi_to_income_ratio`: Relación entre la cuota mensual del préstamo (EMI, Equated Monthly Installment) y el ingreso mensual del comprador.
- `satisfaction_score`: Puntuación de satisfacción subjetiva del comprador (escala 1–10).
- `neighbourhood_rating`: Puntuación de la zona o vecindario (escala 1-10).
- `connectivity_score`: Medida de accesibilidad y transporte de la propiedad (escala 1-10).
- `decision`: Variable objetivo binaria: *1 = Compra aprobada / 0 = No compra*.

# 2. Análisis exploratorio de los datos

## 2.1 Importar datos y librerías

```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(corrplot)
library(scales)
library(broom)
library(car)

data <- read.csv('./global_house_purchase_dataset.csv')
glimpse(data)
```

- ¿Hay valores faltantes? ¿Y duplicados?
```{r}
sum(is.na(data))
sum(duplicated(data))
```

## 2.2 Resumen estadístico general

```{r}
data %>%
  select_if(is.numeric) %>%
  summary()
```
```{r}
sapply(data %>% select(where(is.character)), n_distinct)
```

## 2.3 Visualización de datos

### **Distribución de la variable `decision`**

```{r}
data %>%
  count(decision) %>%
  mutate(pct = n/sum(n)*100,
         decision = factor(decision, labels = c("No compra", "Compra"))) %>%
  ggplot(aes(x = decision, y = pct, fill = decision)) +
  geom_col() +
  geom_text(aes(label = sprintf("%.2f%%", pct)), 
            vjust = 1.5, color = "black", size = 4) +
  labs(title = "Distribución de la decisión de compra",
       x = "Decisión", y = "%") +
  scale_fill_manual(values = c("#F8766D", "#00BA38")) +
  theme_minimal() +
  theme(legend.position = "none")
```

El gráfico representa la distribución porcentual de la variable decision, que indica si un cliente decide o no comprar una vivienda. Se observa un desequilibrio marcado entre ambas categorías: el 76.97% de los individuos no realiza la compra, mientras que solo el 23.03% decide concretarla.

Esta distribución desequilibrada es un aspecto importante a considerar, ya que puede influir en el rendimiento de los modelos predictivos.

### **Distribución del precio**

```{r}
ggplot(data, aes(x = price)) +
  geom_histogram(fill = "#69b3a2", color = "white", bins = 40) +
  scale_x_continuous(labels = comma) +
  labs(title = "Distribución del precio de las viviendas",
  x = "Precio (USD)", y = "Frecuencia") +
  theme_minimal()
```

El histograma muestra la distribución del precio de las viviendas en dólares estadounidenses (USD). Se observa una distribución asimétrica a la derecha, parecida a una distribución gamma, lo que indica que la mayoría de los inmuebles se concentran en los rangos de precios más bajos, mientras que un número reducido de propiedades presenta precios considerablemente más altos.

La mayor frecuencia de viviendas se sitúa aproximadamente entre los 500,000 y 1,000,000 USD, reflejando que este rango constituye el segmento más representativo del mercado analizado. A partir de valores superiores a los 2 millones de dólares, la frecuencia disminuye progresivamente, mostrando la presencia de propiedades de lujo que elevan la cola derecha de la distribución.

A continuación, aplicaremos una transformación logarítmica al precio con el objetivo de aproximar su distribución a una normal.

```{r}
data <- data %>% mutate(log_price = log(price))

ggplot(data, aes(x = log_price)) +
  geom_histogram(fill = "#69b3a2", color = "white", bins = 40) +
  scale_x_continuous() +
  labs(title = "Distribución del logaritmo del precio de las viviendas",
  x = "Precio (USD)", y = "Frecuencia") +
  theme_minimal()
```

Tras aplicar la transformación logarítmica al precio de las viviendas, se observa que la distribución se aproxima más a una distribución normal, corrigiendo la fuerte asimetría a la derecha presente en los valores originales.

### **Distribución del precio por país y por tipo de propiedad**

```{r}
# Boxplot de precios por país
data %>%
  ggplot(aes(x = country, y = price)) +
  geom_boxplot(fill = "#56B4E9", outlier.alpha = 0.2) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(title = "Distribución del precio por país (Top 10)",
       x = "País", y = "Precio (USD)") +
  theme_minimal()
```

En este gráfico se aprecia que Singapur, Emiratos Árabes Unidos (UAE), Japón y Estados Unidos presentan los precios medianos más altos, así como una mayor dispersión, lo que refleja mercados con viviendas de alto valor y mayor desigualdad de precios. En contraste, países como Brasil, India y Sudáfrica muestran precios sustancialmente más bajos y con menor variabilidad, indicando mercados más accesibles y homogéneos.

```{r}
# Boxplot de precios por tipo de propiedad

data %>%
  ggplot(aes(x = property_type, y = price)) +
  geom_boxplot(fill = "#56B4E9", outlier.alpha = 0.2) +
  scale_y_continuous(labels = comma) +
  coord_flip() +
  labs(title = "Distribución del precio por tipo de propiedad (Top 10)",
       x = "Propiedad", y = "Precio (USD)") +
  theme_minimal()
```

Por otro lado, el boxplot por tipo de propiedad evidencia que no hay diferencias estructurales dentro de cada mercado. Si bien es cierto que hay propiedades muy caras (outliers) en todos los tipos de propiedades, las distribuciones centrales son bastante similares, sin diferencias estructurales marcadas entre categorías.

### **Relaciones entre variables numéricas**

```{r}
# Seleccionar variables numéricas relevantes

num_vars <- data %>%
  select_if(is.numeric) %>%
  select(-property_id)

# Matriz de correlación

corr_matrix <- cor(num_vars)

corrplot(corr_matrix, method = "color", type = "upper", tl.col = "black", order = "hclust")
```

El análisis de las relaciones entre las variables numéricas revela patrones coherentes con el comportamiento esperado en un contexto inmobiliario. 

En primer lugar, se observa una correlación positiva entre el precio de la vivienda y el tamaño del inmueble (`property_size_sqft`), lo cual es lógico, ya que las propiedades de mayor superficie tienden a tener precios más altos.

Asimismo, variables como el salario del comprador (`customer_salary`), la cantidad inicial que el comprador aporta (`down_payment`) y el monto del préstamo (`loan_amount`) muestran también una relación directa con el precio, reflejando que los compradores con mayor capacidad económica tienden a adquirir viviendas más costosas.

En cuanto a correlaciones negativas, vemos una relación lógica entre `customer_salary` y `emi_to_income_ratio`: cuanto mayor es el salario del comprador, menor es la proporción que representa la cuota mensual del préstamo respecto a sus ingresos. Esto es coherente, ya que un ingreso alto diluye el peso relativo de la cuota hipotecaria, mejorando la capacidad de pago.

Además, existe una correlación negativa interesante entre `legal_cases_on_property` y `decision`. Esto significa que, a medida que aumentan los casos legales asociados a una propiedad, disminuye la probabilidad de que la decisión final sea positiva (compra aprobada).

### **Relaciones bivariantes**

```{r}
# Salario vs Decisión de compra
data %>%
  mutate(decision = factor(decision, labels = c("No compra", "Compra"))) %>%
  ggplot(aes(x = decision, y = customer_salary, fill = decision)) +
  geom_boxplot(outlier.alpha = 0.2) +
  scale_fill_manual(values = c("#F8766D", "#00BA38")) +
  labs(title = "Salario según decisión de compra",
  x = "Decisión", y = "Salario del cliente") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Número de crímenes reportados vs Precio medio
data %>%
  group_by(crime_cases_reported) %>%
  summarise(mean_price = mean(price, na.rm = TRUE)) %>%
  ggplot(aes(x = factor(crime_cases_reported), y = mean_price)) +
  geom_col(fill = "#56B4E9") +
  scale_y_continuous(labels = comma) +
  labs(title = "Precio medio según el número de crímenes reportados",
  x = "Número de crímenes", y = "Precio medio (USD)") +
  theme_minimal()
```

El análisis de las relaciones bivariantes permite identificar cómo ciertas variables influyen directamente en la decisión de compra y en el precio de la vivienda.  

En primer lugar, se observa que el salario del cliente (`customer_salary`) presenta una relación positiva con la decisión de compra.

Por otra parte, la relación entre el número de crímenes reportados (`crime_cases_reported`) y el precio medio de las viviendas muestra una tendencia inversa: los precios disminuyen a medida que aumenta la incidencia delictiva.

### **Decisión de compra por país**

```{r}
# ¿Qué porcentaje de personas toma la decisión de comprar una vivienda en cada país?
data %>%
  group_by(country) %>%
  summarise(pct_purchase = mean(decision) * 100) %>%
  arrange(desc(pct_purchase)) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(country, pct_purchase), y = pct_purchase)) +
  geom_col(fill = "#009E73") +
  geom_text(aes(label = sprintf("%.2f%%", pct_purchase)), 
            hjust = 1.2, color = "white", size = 4) +
  coord_flip() +
  labs(title = "Porcentaje de decisión de compra por país (Top 10)",
  x = "País", y = "% de compras") +
  theme_minimal()
```

El análisis de la decisión de compra por país revela diferencias significativas en el comportamiento de los compradores según su ubicación geográfica.

Se observa que algunos países presentan una mayor proporción de decisiones de compra positivas, lo que puede estar relacionado con factores como la estabilidad económica, el nivel de ingresos promedio o las características del mercado inmobiliario local.

# 3. Contraste de hipótesis y estadística inferencial

En esta sección se pretende verificar estadísticamente algunas de las relaciones sugeridas en el análisis exploratorio previo. Para ello, se formulan hipótesis estadísticas y se aplican pruebas de contraste adecuadas según el tipo de variable y la distribución observada.

## 3.1 Diferencias de precio entre países

Hipótesis:

- H0: El precio medio es igual entre los países.
- H1: Al menos un país presenta un precio medio distinto.

```{r}
# Test de normalidad
shapiro.test(sample(data$log_price, 5000))
```

El test de Shapiro–Wilk, aplicado a una muestra aleatoria de la variable `log_price`, muestra un p-value < 2.2e-16, lo que sugiere que la variable transformada no sigue una distribución normal perfecta. No obstante, dado el gran tamaño muestral, el ANOVA resulta suficientemente robusto frente a desviaciones de normalidad, por lo que la ligera falta de ajuste no compromete la validez del análisis.

A continuación, se realiza la prueba de Levene para ver si las varianzas entre países son homogéneas o no, y esto nos indicará si podemos utilizar el test paramétrico de ANOVA o, en caso contrario, el de Kruskal-Wallis.

```{r}
# Test de homogeneidad de varianzas
leveneTest(log_price ~ factor(country), data = data)
```

El resultado (p = 0.126) sugiere que no existe evidencia suficiente para rechazar la hipótesis nula de igualdad de varianzas, cumpliéndose así el supuesto de homocedasticidad. Por ello, se aplicó un ANOVA clásico para comparar el precio medio entre países usando la variable transformada.

```{r}
# ANOVA
anova_country <- aov(log_price ~ factor(country), data = data)
summary(anova_country)
```

El ANOVA realizado sobre el precio de la vivienda en su escala logarítmica revela diferencias estadísticamente significativas entre países. El modelo muestra un p-value < 2e-16, lo que indica que la variación del precio medio de las viviendas difiere de forma sustancial según el país.

Ahora llevaremos a cabo el test de Tukey para ver qué países difieren entre sí en el precio medio. Este test incluye una corrección automática del error familiar (FWER), garantizando que la probabilidad de obtener falsos positivos se mantenga controlada al realizar múltiples comparaciones simultáneas.

```{r}
# Post-hoc Tukey
tukey <- TukeyHSD(anova_country)
tukey
sum(tukey[["factor(country)"]][, "p adj"]>0.05)
```

El test post-hoc de Tukey mostró diferencias significativas entre todos los pares de países (p-value < 0.05), confirmando que el país de localización es un factor determinante en el precio de la vivienda.

## 3.2 Factores que influyen en la decisión de compra

```{r}
data$decision <- as.factor(data$decision)

model1 <- glm(decision ~ log_price + factor(country) +
                satisfaction_score + bathrooms + rooms +
                previous_owners, data
              = data, family = binomial)

summary(model1)
```

```{r}
coef_plot <- tidy(model1) %>%
  filter(term != "(Intercept)") %>%
  mutate(signif = ifelse(p.value < 0.05, "*", ""),
         term = paste0(term, signif),
         term = reorder(term, estimate))

ggplot(coef_plot, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax =
                      estimate + std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Efecto de las variables en la probabilidad de
       compra",
       x = "Variables", y = "Coeficiente")
```

El modelo de regresión logística muestra que la decisión de compra está influida principalmente por el precio de la vivienda (en su escala logarítmica), el país donde se ubica el inmueble y el nivel de satisfacción del comprador. En particular, se observa que el coeficiente de log_price es negativo y altamente significativo (p-value < 2e-16), lo que indica que, a medida que el precio aumenta, la probabilidad de que el comprador decida adquirir la vivienda disminuye. Este resultado sugiere que la capacidad económica es un factor limitante importante en la decisión.

La variable satisfaction_score presenta un efecto positivo y muy significativo (p-value < 2e-16), implicando que un mayor nivel de satisfacción incrementa considerablemente la probabilidad de compra. Este resultado destaca el papel de la percepción personal y la valoración emocional del inmueble en la toma de decisiones, además de los factores económicos.

En cuanto al país de residencia, se identifican diferencias significativas entre mercados. Los compradores en Brasil, India, Sudáfrica, Singapur, Emiratos Árabes Unidos y Estados Unidos presentan probabilidades de compra significativamente menores en comparación con el país de referencia (Australia).

Por el contrario, variables relacionadas con las características físicas del inmueble —como el número de baños (`bathrooms`), de habitaciones (`rooms`) o de propietarios anteriores (`previous_owners`)— no muestran efectos estadísticamente significativos cuando se controlan las demás variables del modelo.

# 4. PCA: Análisis de Componentes Principales

El análisis de componentes principales (PCA) es clave para identificar los factores que explican la mayor parte de la variabilidad en nuestro conjunto de datos.

```{r}
# PCA no admite factores ni variables categóricas
pca_data <- data %>%
  select(property_size_sqft, price, log_price,constructed_year,
         previous_owners, rooms, bathrooms, garage, garden,
         crime_cases_reported, legal_cases_on_property,
         customer_salary, loan_amount, loan_tenure_years,
         monthly_expenses, down_payment, emi_to_income_ratio,
         satisfaction_score, neighbourhood_rating,
         connectivity_score)

pca_result <- prcomp(pca_data, scale. = TRUE)
summary(pca_result)
```

## 4.1 Varianza explicada los componentes

```{r}
varianza_explicada <- pca_result$sdev^2 /sum(pca_result$sdev^2)
varianza_acumulada <- cumsum(varianza_explicada)

df_varianza <- data.frame(
  Componente = 1:length(varianza_acumulada),
  Varianza_Acumulada = varianza_acumulada
)

ggplot(df_varianza, aes(x = Componente, y = Varianza_Acumulada)) +
  geom_line(color = "#0072B2", linewidth = 1) +
  geom_point(color = "#0072B2", size = 2) +
  geom_hline(yintercept = 0.80, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Varianza explicada acumulada",
       x = "Número de Componentes",
       y = "Varianza Acumulada") +
  scale_x_continuous(breaks = df_varianza$Componente)
```

Los resultados indican que el primer componente principal (PC1) captura una porción significativa de la varianza total, alrededor del 20%. Además, los primeros diez componentes en conjunto explican cerca del 70–75% de la variabilidad del conjunto de datos.

## 4.2 ¿Qué información nos dan las dos primeras componentes?

```{r}
# Extraer scores de las dos primeras componentes
scores <- as.data.frame(pca_result$x[,1:2])
scores$country <- data$country

ggplot() +
  geom_point(data = scores, aes(x = PC1, y = PC2, color =
                                  country), alpha = 0.6) +
  theme_minimal() +
  labs(title = "Primeras dos componentes del PCA",
       x = "PC1",
       y = "PC2",
       color = "País")
```

## 4.3 Variables que más contribuyen a PC1 y PC2

```{r}
# Qué variables contribuyen a PC1 y PC2
loadings <- as.data.frame(pca_result$rotation[,1:2])
loadings$variable <- rownames(loadings)

# Contribución para PC1
PC1_contrib_df <- loadings %>%
  select(PC1) %>%
  arrange(desc(PC1))

# Contribución para PC2
PC2_contrib_df <- loadings %>%
  select(PC2) %>%
  arrange(desc(PC2))

head(PC1_contrib_df, 5)
head(PC2_contrib_df, 5)
```

PC1 está fuertemente asociado con el nivel económico y el tamaño de la propiedad. Las variables financieras (precio, cantidad de préstamo, pago inicial) y el tamaño del inmueble tienen cargas altas y positivas, lo que indica que este componente captura principalmente un gradiente de propiedades de mayor costo y mayor superficie frente a propiedades más económicas y pequeñas.

PC2 está dominado casi exclusivamente por la estructura interna del inmueble (número de habitaciones y baños). Estos dos atributos se mueven prácticamente de forma conjunta y definen la configuración habitacional del inmueble, independientemente del precio total.