---
title: "Análisis de los factores que influyen en la decisión de compra de vivienda a nivel internacional"
author: "Ander Castro & Lucas Martinez"
date: "2025-11-06"
output:
  cleanrmd::html_document_clean:
    theme: kacit
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
      smooth_scroll: true
link-citations: true
---

```{r, echo=FALSE, out.width="100%", fig.align="center"}
knitr::include_graphics("./portada.png")
```

# 1. Introducción
La compra de vivienda es uno de los procesos financieros más importantes para los individuos y familias en todo el mundo. Para la mayoría de compradores, esta adquisición se realiza a través de un préstamo hipotecario, por lo que las instituciones financieras evalúan múltiples factores para determinar si un solicitante es elegible para un crédito y bajo qué condiciones.

El mercado inmobiliario global es un sector clave en la economía, moviendo miles de millones de dólares anualmente. La correcta evaluación del perfil financiero del comprador, junto con las características del inmueble, es fundamental tanto para garantizar el acceso a la vivienda como para reducir el riesgo económico de las entidades financieras.

## 1.1 Obtención de los datos
El set de datos fue obtenido de la plataforma Kaggle y contiene información global sobre compras de vivienda y decisiones de aprobación hipotecaria. Incluye 200,000 registros (muestras) con 25 variables relacionadas tanto con la propiedad como con el comprador y su historial financiero.

El objetivo principal de este estudio es realizar un análisis estadístico para comprender qué factores influyen en la aprobación o rechazo de un préstamo hipotecario. Asimismo, se buscará identificar qué características del comprador y de la propiedad tienen mayor peso en la decisión final y desarrollar modelos predictivos que permitan anticipar el resultado de aprobación crediticia.

## 1.2 Metodología

A lo largo de este trabajo, se pretenden analizar las siguientes preguntas:

- *¿Qué variables explican mejor el precio de una vivienda?*
  - ¿Influyen el país, tipo de propiedad, tamaño, número de habitaciones o el estado de
  mobiliario?
  - ¿Qué relación existe entre el precio y variables como el salario del comprador, el
  número de propietarios anteriores o el año de construcción?
  
- *¿Qué factores determinan la decisión de compra (variable decision)?*
  - ¿Qué peso tienen variables como el ratio EMI/income, el nivel de satisfacción
  (satisfaction_score), el rating del vecindario (neighbourhood_rating) o la conectividad
  (connectivity_score)?
  - ¿Se puede predecir la decisión de compra con un modelo de clasificación?
  
- *¿Existen diferencias significativas entre países o ciudades en cuanto a precios y decisiones de compra?*
  - ¿Qué países tienen precios más altos en promedio?
  - ¿Hay diferencias en la tasa de compra (decision = 1) entre regiones?

- *¿Cómo se distribuye el precio de las viviendas y hasta qué punto es posible predecirlo con modelos estadísticos y de machine learning?*
  - ¿Se ajusta a una distribución teórica conocida (gamma, log-normal, normal)?
  - ¿Qué modelo de regresión (lineal, regularizado o de machine learning) ofrece mejor
  rendimiento en la predicción del precio?
  - ¿Qué variables son más relevantes en la estimación?
  
- *¿Qué insights se pueden extraer sobre el perfil del comprador?*
  - ¿Qué relación hay entre salario, gastos mensuales, préstamo y decisión de compra?
  - ¿Influyen los aspectos legales (legal_cases_on_property) o de seguridad
  (crime_cases_reported)?

El análisis se llevará a cabo en dos fases principales:

### **Volumen 1: Análisis Exploratorio y Estadístico**
1. Importación de librerías y datos  
2. Resumen estadístico general 
3. Visualización de datos
4. Contraste de hipótesis y estadística inferencial
5. PCA: Análisis de Componentes Principales  
    - Varianza explicada  
    - Componentes principales

### **Volumen 2: Machine Learning**
6. Modelo para la decisión de compra (clasificación)  
7. Modelo para el precio de la vivienda  
8. Interpretación de resultados
9. Conclusiones y limitaciones
10. Referencias

## 1.3 Variables del dataset
El dataset incluye 200,000 registros con información sobre propiedades y compradores.
En total hay 25 variables, pero a continuación se presentan las variables más relevantes:

  - `price`: Precio de la vivienda
  - `property_type`, `furnishing_status`: Tipo y nivel de amueblado        
  - `property_size_sqft`: Tamaño del inmueble              
  - `country`, `city`: Ubicación geográfica             
  - `customer_salary`: Salario anual del comprador      
  - `credit_score`: Puntaje crediticio               
  - `loan_amount`, `loan_tenure_years`: Monto y duración del préstamo    
  - `monthly_expenses`: Gastos mensuales                 
  - `previous_loans`, `missed_payments`: Historial financiero             
  - `crime_cases_reported`: Seguridad del entorno            
  - `decision`: 1 = Compra aprobada, 0 = No compra


# 2. Análisis exploratorio de los datos

## 2.1 Importar datos y librerías

```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(corrplot)
library(scales)
library(broom)
library(car)

data <- read.csv('./global_house_purchase_dataset.csv')
glimpse(data)
```

- ¿Hay valores faltantes? ¿Y duplicados?
```{r}
sum(is.na(data))
sum(duplicated(data))
```

## 2.2 Resumen estadístico general
```{r}
data %>%
  select_if(is.numeric) %>%
  summary()
```
```{r}
sapply(data %>% select(where(is.character)), n_distinct)
```

## 2.3 Visualización de datos

### **Distribución de la variable `decision`**
```{r}
data %>%
  count(decision) %>%
  mutate(pct = n/sum(n)*100,
         decision = factor(decision, labels = c("No compra", "Compra"))) %>%
  ggplot(aes(x = decision, y = pct, fill = decision)) +
  geom_col() +
  geom_text(aes(label = sprintf("%.2f%%", pct)), 
            vjust = 1.5, color = "black", size = 4) +
  labs(title = "Distribución de la decisión de compra",
       x = "Decisión", y = "%") +
  scale_fill_manual(values = c("#F8766D", "#00BA38")) +
  theme_minimal() +
  theme(legend.position = "none")
```

### **Distribución del precio**
```{r}
ggplot(data, aes(x = price)) +
  geom_histogram(fill = "#69b3a2", color = "white", bins = 40) +
  scale_x_continuous(labels = comma) +
  labs(title = "Distribución del precio de las viviendas",
  x = "Precio (USD)", y = "Frecuencia") +
  theme_minimal()
```

En este histograma podemos ver cómo el precio sigue una distribución parecida a una gamma. Ahora vamos a ver si aplicando una transformación logarítmica, obtenemos una distribución más parecida a una normal.

```{r}
data <- data %>% mutate(log_price = log(price))

ggplot(data, aes(x = log_price)) +
  geom_histogram(fill = "#69b3a2", color = "white", bins = 40) +
  scale_x_continuous() +
  labs(title = "Distribución del logaritmo del precio de las viviendas",
  x = "Precio (USD)", y = "Frecuencia") +
  theme_minimal()
```

### **Distribución del precio por país y por tipo de propiedad**
```{r}
# Boxplot de precios por país
data %>%
  ggplot(aes(x = country, y = price)) +
  geom_boxplot(fill = "#56B4E9", outlier.alpha = 0.2) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(title = "Distribución del precio por país (Top 10)",
       x = "País", y = "Precio (USD)") +
  theme_minimal()

# Boxplot de precios por tipo de propiedad

data %>%
  ggplot(aes(x = property_type, y = price)) +
  geom_boxplot(fill = "#56B4E9", outlier.alpha = 0.2) +
  scale_y_continuous(labels = comma) +
  coord_flip() +
  labs(title = "Distribución del precio por tipo de propiedad (Top 10)",
       x = "Propiedad", y = "Precio (USD)") +
  theme_minimal()
```

### **Relaciones entre variables numéricas**
```{r}
# Seleccionar variables numéricas relevantes

num_vars <- data %>%
  select_if(is.numeric) %>%
  select(-property_id)

# Matriz de correlación

corr_matrix <- cor(num_vars)

corrplot(corr_matrix, method = "color", type = "upper", tl.col = "black", order = "hclust")
```

### **Relaciones bivariantes**
```{r}
# Salario vs Decisión de compra
data %>%
  mutate(decision = factor(decision, labels = c("No compra", "Compra"))) %>%
  ggplot(aes(x = decision, y = customer_salary, fill = decision)) +
  geom_boxplot(outlier.alpha = 0.2) +
  scale_fill_manual(values = c("#F8766D", "#00BA38")) +
  labs(title = "Salario según decisión de compra",
  x = "Decisión", y = "Salario del cliente") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Número de crímenes reportados vs Precio medio
data %>%
  group_by(crime_cases_reported) %>%
  summarise(mean_price = mean(price, na.rm = TRUE)) %>%
  ggplot(aes(x = factor(crime_cases_reported), y = mean_price)) +
  geom_col(fill = "#56B4E9") +
  scale_y_continuous(labels = comma) +
  labs(title = "Precio medio según el número de crímenes reportados",
  x = "Número de crímenes", y = "Precio medio (USD)") +
  theme_minimal()
```

### **Decisión de compra por país**
```{r}
# ¿Qué porcentaje de personas toma la decisión de comprar una vivienda en cada país?
data %>%
  group_by(country) %>%
  summarise(pct_purchase = mean(decision) * 100) %>%
  arrange(desc(pct_purchase)) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(country, pct_purchase), y = pct_purchase)) +
  geom_col(fill = "#009E73") +
  geom_text(aes(label = sprintf("%.2f%%", pct_purchase)), 
            hjust = 1.2, color = "white", size = 4) +
  coord_flip() +
  labs(title = "Porcentaje de decisión de compra por país (Top 10)",
  x = "País", y = "% de compras") +
  theme_minimal()
```

# 3. Contraste de hipótesis y estadística inferencial

En esta sección se pretende verificar estadísticamente algunas de las relaciones sugeridas en el análisis exploratorio previo. Para ello, se formulan hipótesis estadísticas y se aplican pruebas de contraste adecuadas según el tipo de variable y la distribución observada.

## 3.1 Diferencias de precio entre países

Hipótesis:

- H0: El precio medio es igual entre los países.
- H1: Al menos un país presenta un precio medio distinto.

```{r}
# Test de normalidad
shapiro.test(sample(data$log_price, 5000))
```

El test de Shapiro-Wilk aplicado a una muestra aleatoria de log(price) muestra un p-value < 2.2e-16, indicando que la variable transformada no sigue una distribución normal perfecta. Sin embargo, dado el gran tamaño muestral, el ANOVA es robusto frente a desviaciones de normalidad.

A continuación, se realiza la prueba de Levene para ver si las varianzas entre países son homogéneas o no, y esto nos indicará si podemos utilizar el test paramétrico de ANOVA o, en caso contrario, el de Kruskal-Wallis.

```{r}
# Test de homogeneidad de varianzas
leveneTest(log_price ~ factor(country), data = data)
```

Antes de realizar el contraste de medias entre países, se evaluó la homogeneidad de varianzas mediante el test de Levene sobre log(price). El resultado (p = 0.126) indica que no existe evidencia suficiente para rechazar la igualdad de varianzas, por lo que se cumple el supuesto de homocedasticidad.
Por ello, se aplicó un ANOVA clásico para comparar el precio medio entre países usando la variable transformada.

```{r}
# ANOVA
anova_country <- aov(log_price ~ factor(country), data = data)
summary(anova_country)
```

El ANOVA resultó significativo (p < 2e-16), lo que indica diferencias en los precios medios entre países.
Posteriormente, se realizó el test de Tukey para ver qué países difieren entre sí en el precio medio.

Este test de Tukey incluye una corrección automática del error familiar (FWER), garantizando que la probabilidad de obtener falsos positivos se mantenga controlada al realizar múltiples comparaciones simultáneas.

```{r}
# Post-hoc Tukey
tukey <- TukeyHSD(anova_country)
sum(tukey[["factor(country)"]][, "p adj"]>0.05)
```

El test post-hoc de Tukey mostró diferencias significativas entre todos los pares de países (p < 0.001), confirmando que el país de localización es un factor determinante en el precio de la vivienda.

## 3.2 Factores que influyen en la decisión de compra

```{r}
data$decision <- as.factor(data$decision)

model1 <- glm(decision ~ log_price + factor(country) +
                satisfaction_score + bathrooms + rooms +
                previous_owners, data
              = data, family = binomial)

summary(model1)
```

```{r}
coef_plot <- tidy(model1) %>%
  filter(term != "(Intercept)") %>%
  mutate(signif = ifelse(p.value < 0.05, "*", ""),
         term = paste0(term, signif),
         term = reorder(term, estimate))

ggplot(coef_plot, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax =
                      estimate + std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Efecto de las variables en la probabilidad de
       compra",
       x = "Variables", y = "Coeficiente")
```

El modelo de regresión logística muestra que la decisión de compra está influida principalmente por el precio de la vivienda (en su escala logarítmica), el país donde se ubica el inmueble y el nivel de satisfacción del comprador. En particular, se observa que el coeficiente de log_price es negativo y altamente significativo (p < .001), indicando que a medida que el precio aumenta, la probabilidad de que el comprador decida adquirir la vivienda disminuye. Esto sugiere que la capacidad económica es un factor limitante importante en la decisión.

La variable satisfaction_score presenta un efecto positivo y muy significativo (p < .001), lo que implica que un mayor nivel de satisfacción subjetiva aumenta notablemente la probabilidad de compra. Este resultado destaca el papel de la percepción personal y la valoración emocional del inmueble en la toma de decisiones, no solo factores económicos.

También se identifican diferencias significativas entre países: compradores en Brasil, India, Sudáfrica, Singapur, Emiratos Árabes Unidos y Estados Unidos muestran probabilidades significativamente diferentes de compra respecto al país de referencia (Australia, por defecto). Esto sugiere que existen diferencias culturales, regulatorias o económicas entre mercados inmobiliarios internacionales que influyen en la decisión de compra.

Por el contrario, variables relacionadas con características físicas del inmueble, como el número de habitaciones (rooms), el número de baños (bathrooms) y el número de propietarios anteriores (previous_owners), no muestran efectos significativos en la decisión de compra cuando se controlan el resto de factores. Esto indica que, en este contexto, las características estructurales parecen tener un papel menos determinante que la satisfacción percibida y el precio relativo.

# 4. PCA: Análisis de Componentes Principales